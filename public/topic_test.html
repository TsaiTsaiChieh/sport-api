<head>
  <title>topics by ifyu</title>
  <script src="/__/firebase/6.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.4.0/firebase.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>
<body>
  <div id="app">
    <div style="width:100%; background-color: lightskyblue;"><a href="auth.html">[登入頁]</a> {{fbAuth ? fbAuth.displayName : '未登入'}}</div>
    <div style="width:100%; text-align: center;"><h3>熱門文章</h3></div>
    <div v-for="(item, index) in topics" style="width:100%; background-color: gray; color: white; margin-top: 10px;">
      <div style="background-color: green; padding:5px">
        <span style="background-color: red;">{{item.content.category}}</span>
        {{item.content.title}}
      </div>
      <div style="white-space: pre; padding:5px;">{{item.content.content}}</div>
      <hr>
      <div style="padding:5px; text-align: right;">讚 {{item.like.length}} / 留言 {{item.reply.length}} / {{item.ranking.viewCount}}人已看過</div>
    </div>
  </div>

  <div style="width:50%; margin: 10px auto; padding: 5px; background-color: lightgrey;">
    <form id="form" width=100%>
      新增文章<br>
      <label>分類
        <select id="category">
          <option value="賽事分析">賽事分析</option>
          <option value="球隊討論">球隊討論</option>
          <option value="投注分享">投注分享</option>
        </select>
      </label>
      / <label>球種
        <select id="type">
          <option value="MLB">MLB</option>
        </select>
      </label><br>
      <label>
        標題<input id="title" style="width:70%">
      </label><br>
      <label>
        內文<textarea rows=5 style="width:70%" id="content"></textarea>
      </label>
      </label><br>
      <label>
        瀏覽次數*<input id="viewCount" style="width:30%">
      </label>
      <button type="button" onclick="doSubmit()">送出</button>
    </form>
  </div>
  <script type="text/javascript">
    const firebaseConfig = {
      apiKey: 'AIzaSyByoBAdesDJHNpT-d31y08UYcOwt5KeaBE',
      authDomain: 'sportslottery-test.firebaseapp.com',
      databaseURL: 'https://sportslottery-test.firebaseio.com',
      projectId: 'sportslottery-test',
      storageBucket: 'sportslottery-test.appspot.com',
      messagingSenderId: '969081540385',
      appId: '1:969081540385:web:da08ff289d0bec4ca9b860',
    };
    firebase.initializeApp(firebaseConfig);
    let db = firebase.firestore();
    let ref = db.collection('topics')

    Vue.config.devtools = true;
    var app = new Vue({
      el: '#app',
      data: {
        topics: [],
        fbAuth: null
      },
      mounted: function(){
        let vm = this;
        firebase.auth().onAuthStateChanged(function(user) {
          if(user){
            vm.fbAuth = user;
          }
        });
        /** 程式碼寫在下面 **/
        let res = [];
        /* 直接存取firestore(撈全部資料) *
        ref.get().then(querySnapshot => {
          querySnapshot.forEach(doc => {
            res.push(doc.data())
          });
          console.log(res)
          this.topics = res;
        }); /**/

        /* 透過api */
        axios.get('/home/hotTopics')
        .then(function(response) {
          response.data.topics.forEach(item => {
            res.push(item)
          });
          console.log(res)
          vm.topics = res;
        })
        .catch(function(error) {
          console.log('asios failed');
        }) /**/
      }
    })

    function doSubmit(){
      let category = document.getElementById('category').value;
      let type = document.getElementById('type').value;
      let title = document.getElementById('title').value;
      let content = document.getElementById('content').value;
      let viewCount = document.getElementById('viewCount').value;
      if(!firebase.auth().currentUser){
        location.href = 'auth.html';
        return;
      }
      if(!title || !content){
        alert('不得為空')
        return;
      }
      ref.doc().set({
        content:{
          category: category,
          content: content,
          type: type,
          title: title,
          time: firebase.firestore.FieldValue.serverTimestamp()
        },
        like: [],
        ranking: {
          viewCount: viewCount,
        },
        reply: [],
        user: {
          displayName: firebase.auth().currentUser.displayName,
          uid: firebase.auth().currentUser.uid
        }
      }).then(() => {
        alert('完成，請重新整理網頁')
      });
    }

  </script>
</body>
