<!DOCTYPE html>
<html>

<head>
    <title>Firebase Authentication UI templete ver.0717</title>
    <script src="https://www.gstatic.com/firebasejs/ui/4.2.0/firebase-ui-auth__zh_tw.js"></script>
    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/4.2.0/firebase-ui-auth.css"/>
    <script src="/__/firebase/6.6.1/firebase-app.js"></script>
    <script src="/__/firebase/init.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.4.0/firebase.js"></script>
</head>

<body>
<div id="firebaseui-auth-container"></div>
<div id="chat">
    <input type="file" id="fileButton" value="upload">
    <button type="button" onclick="getonce()">get once</button>
    <div id="test"></div>
</div>
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script type="text/javascript">
    const firebaseConfig = {
        apiKey: "AIzaSyB31V6WewUi-iY12231Ixahquf68uGaoCo",
        authDomain: "sport19y0715.firebaseapp.com",
        databaseURL: "https://sport19y0715.firebaseio.com",
        projectId: "sport19y0715",
        storageBucket: "sport19y0715.appspot.com",
        messagingSenderId: "179049951227",
        appId: "1:179049951227:web:15b2ae874d653216"
    };

    firebase.initializeApp(firebaseConfig);

    //firestorage upload example
    let storage = firebase.storage();
    let fileButton = document.getElementById("fileButton");
    fileButton.addEventListener("change", async function (e) {
        let file = e.target.files[0];
        let storageRef = firebase.storage().ref('photo/' + file.name);
        const result = await storageRef.put(file);
        const url = await result.ref.getDownloadURL();
        console.log(result);
        console.log(' * new url', url);
        // console.log(JSON.stringify( result, null, " " ));
    });

    //firebase realtime examle
    let messageSize = 10;      //頁面刷新預載訊息數
    let messageTotalSize = 10;  //回滾訊數息量
    let firstMessageTime;       // for filter
    let messages;
    const database = firebase.database();
    let public_chat = database.ref("/chat_public");

    const presenceRef = database.ref('/.info/connected');
    const listRef = database.ref('/chat_room_users/public/');
    const userRef = listRef.push();

    presenceRef.on('value', function(snap) {
        if (snap.val()) {
            userRef.onDisconnect().remove();
            userRef.set(true);
        }
    });

    listRef.on('value', function(snap) {
        console.log('# of online users = ' + snap.numChildren());
    });

    public_chat.orderByChild("createTime/_seconds").limitToLast(1).on("child_added", function (snapshot) {
        console.log(snapshot.key, snapshot.val());
    });
    public_chat.limitToLast(messageTotalSize).orderByChild("createTime/_seconds").on("child_changed", function (snapshot) {
        console.log(snapshot.key, snapshot.val());
    });

    public_chat.orderByChild('createTime/_seconds').limitToLast(messageSize)
        .once('value', async function (snapshot) {
            let temp1 = [];
            snapshot.forEach(function (record) {
                // console.log(record.key);
                temp1.push(record.val().createTime._seconds);
                console.log(record.key, record.val());
            });
            firstMessageTime = temp1[0] - 1;
            console.log(temp1[0], firstMessageTime)
        });

    function getonce() {
        public_chat.endAt(firstMessageTime).orderByChild('createTime/_seconds').limitToLast(messageSize)
            .once('value', async function (snapshot) {
                let temp1 = [];
                snapshot.forEach(function (record) {
                    // console.log(record.key);
                    temp1.push(record.val().createTime._seconds);
                    console.log(record.key, record.val());
                });
                firstMessageTime = temp1[0] - 1;
                messageTotalSize += temp1.length;
                console.log("message size", messageTotalSize)
                public_chat.limitToLast(messageTotalSize).orderByChild("createTime/_seconds").on("child_changed", function (snapshot) {
                    console.log(snapshot.key, snapshot.val());
                });
            });
    }
</script>
</body>

</html>
