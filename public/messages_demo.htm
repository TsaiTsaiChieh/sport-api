<!DOCTYPE html />
<html>

	<head>
		<meta charset="utf-8" />
		<title>
			messages api demo
		</title>
		<style>
			#messagePool {
				width: 100%;
				height: 500px;
				background-color: #eee;
				overflow: auto;
			}

			textarea {
				width: 300px;
				height: 100px;
			}

			.avatar {
				width: 50px;
				height: 50px;
			}

			.msg {
				display: flex;
			}
		</style>
	</head>

	<body onload="init2();">
		<div id="messagePool">
			<div id="" class="message">123</div>
			<div id="" class="message">234</div>
		</div>
		<img id="img_see" width="100" height="100" />
		<img id="img_see2" width="100" height="100" />
		<img id="img_see3" width="100" height="100" />
		<video width="100" height="100" id="video_see" controls>
			<source src="" id="media_file" />
		</video>
		<audio id="audio_see" preload="auto" controls>
			<source id="audio_file" src="" />
		</audio>
		<br />
		點選的訊息ID
		<input type="text" id="selectMessageId" readonly="readonly" />
		<input type="button" id="bt_clearId" value="清除選擇Id" />
		<br />
		<br />
		<input type="button" id="bt_delete0" value="刪除選擇的訊息(全域)" />
		<input type="button" id="bt_delete_1" value="管理員權限刪除文章" />
		<input type="button" id="bt_delete1" value="對自己隱藏選擇的訊息" />
		<br />
		<input type="button" id="bt_report" value="檢舉選擇的訊息" />
		<input type="button" id="bt_report_1" value="取消檢舉訊息" />
		<br />
		是否夾帶檔案
		<input type="file" id="fileUpload" />
		<input type="text" id="fileSize" readonly="readonly" value="檔案大小" maxlength="100" size="15" />
		<input type="button" id="bt_clearFile" value="清除選擇file" /><br />
		發送內容
		<textarea id="messageContent" maxlength="1000" wrap="soft">123 </textarea>

		<input type="button" id="bt_send" value="發送新訊息" /><br />回應的error<textarea id="returnError" maxlength="1000" wrap="soft"> 123</textarea><br /><br />取得特定訊息(不是讀取快取而是發出POST拿)<textarea id="oneMessage" maxlength="1000" wrap="soft"> </textarea><br />
		<br />
	</body>

	<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
	<script src="https://www.gstatic.com/firebasejs/7.4.0/firebase.js"></script>
	<script src="https://raw.githubusercontent.com/jedisct1/siphash-js/master/lib/siphash.js.min"></script>
	<script src="https://momentjs.com/downloads/moment-with-locales.min.js"></script>


	<script type="text/javascript">
		const url = '/messages_temp/'; // location.host.concat( '/messages/' ); //prfx //https://sport19y0715.firebaseapp.com/messages/ // "https://sport19y0715.web.app"

		var firebaseAuth;
		var rtdb; //Realtime database
		//let fsdb; //Cloud Firestore
		var authUserData; //直接前端驗證的用戶資料,有uid

		var userData = {}; //post到後端拿用戶資料,比較完整

		var fileUrl5T = ""; //準備傳到後端的檔案網址
		var fileContent; //當有選取檔案,這裡就會有內容,用於上傳
		var fileName = '';
		var fileType = '';

		var storage5t;
		//var File1 = "";//C:\fakepath\login1..jpg //不可信的臨時路徑
		//var fileBuffer; //當有選取檔案,這裡就會有內容,用於上傳
		//fileBuffer.byteLength//真實大小

		var roundDecimal = function ( val, precision ) {
			return Math.round( Math.round( val * Math.pow( 10, ( precision || 0 ) + 1 ) ) / 10 ) / Math.pow( 10, precision || 0 );
		};

		function unToDef( inp, def ) {
			if ( inp === undefined ) {
				return def;
			}

			if ( inp === null ) {
				return def;
			}

			return inp;
		}

		function timeStampYMDhmsA( timeStamp ) {
			return moment( timeStamp ).format( "YYYY-MM-DD A h:mm:ss" );
		}

		function kmb( size = 0 ) {
			let ans = {};
			ans.size = Number.parseInt( size, 10 ) || 0;
			if ( size > 0 ) {
				if ( ans.size <= 1024 ) {
					ans.unit = "B";
					return ans;
				}

				ans.size = roundDecimal( ans.size * 0.001, 2 );

				if ( ans.size <= 1024 ) {
					ans.unit = "KB";
					return ans;
				}

				ans.size = roundDecimal( ans.size * 0.001, 2 );
				ans.unit = "MB";

				return ans;
			}

			ans.size = -1;
			ans.error = "異常輸入";
			return ans;
		}

		function messageToElement( message ) {
			strArr = [];
			strArr.push( '<div class="msg" id="' );
			strArr.push( message.messageId );
			strArr.push( '" >' );

			let avatar = unToDef( message.avatar, "" );
			if ( avatar.toString().length < 1 ) {
				avatar = unToDef( message.avatar, "" );
			}
			//<img class="avatar" src="" ></img>

			if ( avatar.length > 0 ) {
				strArr.push( '<img class="avatar" src="' );
				strArr.push( avatar );
				strArr.push( '" ></img>' );
			}

			strArr.push( " " );
			strArr.push( unToDef( message.displayName, "沒有用戶名稱" ) ); //
			strArr.push( ' : "' );
			strArr.push( message.message ); //
			strArr.push( '"' );
			strArr.push( " " );

			try {
				let msgFile = message.file || "";
				if ( msgFile.length > 0 ) {
					let sizeUnit = kmb( msgFile.length );

					//if ( fileSize.size > 0 ) {
					strArr.push( "夾帶檔案:" ); //
					let fileName = unToDef( message.fileName, "" );
					if ( fileName.length < 1 ) {
						fileName = "未知檔名";
					}

					strArr.push( fileName );
					strArr.push( " " );
					strArr.push( sizeUnit.size );
					strArr.push( sizeUnit.unit );
					strArr.push( "(" );
					strArr.push( msgFile.substr( 0, 10 ) );
					strArr.push( ")" );
					strArr.push( " " );
					//} //if fileSize.size
				} //if file.length
			} catch ( err4 ) {
				console.warn( err4 );
			}

			strArr.push(
				timeStampYMDhmsA( message.appearTimestamp )
				.replace( "AM", "早上" )
				.replace( "PM", "下午" )
			);

			strArr.push( "</div>" );

			return strArr;
		}

		function newMessageAppend( message ) {
			$( "#messagePool" ).append( messageToElement( message ).join( "" ) ); //插入到最後
		} //newMessageAppend

		function tempHashReolaceToMesageId( message ) {
			//當有一個暫時性的訊息

			let tempHashs = $( "#".concat( message.tempHash ) );

			//var cnt = $("#".concat(message.tempHash)).size();
			if ( tempHashs.length > 0 ) {
				$( "#".concat( message.tempHash ) ).attr( "id", message.messageId ); //把暫時性的訊息元素id換成正式訊息id
			} else {
				console.info( "no tempHashs , run newMessageAppend" );
				newMessageAppend( message ); //沒有暫時性的元素,所以把這個訊息插入到最後
			}
		}

		function oldMessagePrepend( message ) {
			console.info( "oldMessagePrepend" );
			console.info( message );
			$( "#messagePool" ).prepend( messageToElement( message ).join( "" ) ); //插入到最前
		}

		function delMessage( sv ) {
			let msgId2 = "#".concat( sv.messageId );
			console.info( "sv msgId2" );
			console.info( msgId2 );

			switch (
				sv.deleteAction //軟刪除狀態;
			) {
				case -1: //-1:管理員刪除(回收),
					$( "#".concat( sv.messageId ) ).remove();
					break;

				case 0: //0用戶刪除(回收,大家全部不能看),
					$( "#".concat( sv.messageId ) ).remove();
					break;

				case 1: //1用戶刪除(自己不能看,其他人可以看)
					if ( sv.uid === authUserData.uid ) {
						$( "#".concat( sv.messageId ) ).remove();
					}
					break;

				default:
					console.warn( "未定義的刪除訊息" );
					console.warn( sv );
					break;
			}
		}

		function trim( str = "" ) {
			switch ( str ) {
				case undefined:
				case null:
				case true:
				case false:
				case NaN:
				case Infinity:
					return "";
					break;
			}
			return str.toString().replace( /^\s+|\s+$/g, "" );
		}


		function upClear() {
			console.info( 'upClear' );


			fileUrl5T = ""; //準備傳到後端的檔案網址
			//var fileContent = ""; //當有選取檔案,這裡就會有內容,用於上傳

			fileType = '';

			fileContent = undefined;
			fileName = '';
			$( "#fileSize" ).val( "" );
			$( "#fileUpload" ).val( "" );

			$( '#img_see2' ).attr( 'src', '' );
			$( '#img_see' ).attr( 'src', '' );
			//$( "#fileUpload" ).change();
		}

		function fileToBase64( File1 ) {
			console.info( 'fileToBase64' );
			let FileReaderBase64 = new FileReader(); //檔案讀取物件//注意,base64不會自動轉回bin,所以不要用base64上傳
			FileReaderBase64.onload = function ( e ) {
				//讀取成功的行為

				try {
					console.info( "FileReaderBase64 onload>>>>" );
					//console.info( '"'.concat( e, '"' ) ); //e.toString().substr( 0, 30 )

					fileName = File1.name;

					/*
					let fileNameSub = '.hex';
					let idot = fileName.lastIndexOf( '.' );
					if ( idot > -1 ) {
						fileNameSub = fileName.substr( idot ); //取原始副檔名
					}
					*/

					/*
					if ( fileContent.length > 50 * 1024 * 1024 ) {
						alert( '檔案太大,無法上傳' );
						return;
					}
					*/

					let fbase64 = e.currentTarget.result || '';

					//fileContent = e.currentTarget.result || "";
					$( "#img_see" ).attr( "src", e.currentTarget.result );
					//$( "#fileSize" ).val( kmb( fileContent.length ) );

					//fileContent = str_def(e.currentTarget.result, "");

					let base64SplitStr = ";base64,"; //base64檔案內容切割與合併用

					let idx = fbase64.indexOf( base64SplitStr );

					if ( idx > -1 ) {
						fileType = fbase64.substr( 0, idx );
					} else {
						fileType = '';
					}

					let datac = 'data:';

					let idx0 = fileType.indexOf( datac );

					if ( idx0 > -1 ) {
						fileType = fileType.substr( idx0 + datac.length );
					}




				} catch ( errFileReaderBase64 ) {
					console.warn( errFileReaderBase64 );
					upClear();
				}
			};

			FileReaderBase64.readAsDataURL( File1 ); //真的讀取
		} //fileToBase64

		function fileToBuffer( File1 ) {
			console.info( 'fileToBuffer' );

			let FileReaderBuffer = new FileReader(); //檔案讀取物件
			FileReaderBuffer.onload = function ( e ) {

				try {
					console.info( "FileReaderBuffer onload>>>>" );

					fileBuffer = e.currentTarget.result; //buffer格式內容,
					console.info( fileBuffer );

					if ( fileBuffer.byteLength < 1 ) { //沒有內容
						console.warn( '檔案沒有內容,不允許上傳' );
						upClear(); //失敗就清空
						return;
					}

					if ( fileBuffer.byteLength > 50 * 1024 * 1024 ) {
						console.warn( '檔案超過50MB,不允許上傳' );
						upClear(); //失敗就清空
						return;
					}

					console.info( 'fileBuffer : ' );
					console.info( fileBuffer );

					fileContent = fileBuffer;
					fileName = File1.name;

					let sizeUnit = kmb( fileBuffer.byteLength );

					$( "#fileSize" ).val( ''.concat( sizeUnit.size, sizeUnit.unit ) );

					fileToBase64( File1 );

					return;

					/*
					fileContent = fileBuffer;
						fileName=File1.name;
						let fileNameSub='.hex';

						let idot=fileName.lastIndexOf('.');
						if (idot>-1) {
						fileNameSub=fileName.substr(idot);//取原始副檔名
						}

						let timeNow=new Date();

						let storageRef = storage5t.ref( 'uploadTemp/'.concat( uid, '/', timeNow.getTime(),fileName2 ) ); //5T區域路徑

						let uploadTask = storageRef.put( fileBuffer );

						uploadTask.on( 'state_changed', function ( snapshot ) {
						// Observe state change events such as progress, pause, and resume
						// Get task progress, including the number of bytes uploaded and the total number of bytes to be uploaded
						let progress = 0;

						if ( snapshot.bytesTransferred > 0 ) {
						Math.roundDecimal
						progress = Math.ceil( ( snapshot.bytesTransferred / snapshot.totalBytes ) * 100 ); // RoundFloat;
						}

						console.info( 'progress = '.concat( progress, ' %' ) );

						switch ( snapshot.state ) {
						case firebase.storage.TaskState.PAUSED: // or 'paused'
						console.info( 'Upload is paused' );
						break;
						case firebase.storage.TaskState.RUNNING: // or 'running'
						console.info( 'Upload is running' );
						break;
						}
						}, function ( errorUploadTask ) {
						//非同步錯誤訊息
						console.warn( errorUploadTask );
						}, function () {
						//非同步完成行為

						uploadTask.snapshot.ref.getDownloadURL().then( function ( downloadURL ) {
						try {
						console.info( 'File URL = '.concat( downloadURL ) );
						//範例:https://firebasestorage.googleapis.com/v0/b/sport19y0715.appspot.com/o/test%2Fpoe%E5%A4%A9%E8%B3%A6%E6%8F%9B%E7%AE%97.jpg?alt=media&token=d829d412-c7d6-4635-8294-5c3fcab6e84b
						//注意https://firebasestorage.googleapis.com/v0/b/sport19y0715.appspot.com/o/test%2Fpoe%E5%A4%A9%E8%B3%A6%E6%8F%9B%E7%AE%97.jpg 至此,內容是資訊JSON不是檔案內容.
						//要加上 ?alt=media&token=... 之後才是圖片內容

						$( '#pic2' ).attr( 'src', downloadURL );
						} catch ( errorGetDownloadURL ) {
						console.warn( errorGetDownloadURL );
						}

						} ); //uploadTask.snapshot.ref.getDownloadURL().then

						} ); //uploadTask.on

						*/


				} catch ( errorFileReaderBuffer ) {
					console.warn( errorFileReaderBuffer );
					upClear(); //失敗就清空
				} //try errorFileReaderBuffer
			}; //FileReaderBuffer.onload

			FileReaderBuffer.readAsArrayBuffer( File1 ); //Buffer
		} //fileToBuffer

		function sendPost( fileUrl = '' ) {
			console.info( 'sendPost' );
			try {
				let xhr = new XMLHttpRequest();
				xhr.open( "POST", url.concat( "create" ), true );
				xhr.setRequestHeader( "Content-type", "application/json" );
				xhr.withCredentials = true;
				//let params = {};
				xhr.onreadystatechange = function () {
					try {
						if ( xhr.readyState == 4 && xhr.status == 200 ) {

							//
							console.info( xhr.response );
							let getJson = JSON.parse( xhr.response );
							$( "#oneMessage" ).val( JSON.stringify( getJson, null, " " ) );
							$( "#returnError" ).val( getJson.error );

						} //if
					} catch ( err ) {
						console.warn( err );
					} //try


				}; //onreadystatechange

				postData = {
					channelId: "public",
					tempHash: new Date().getTime().toString().concat( authUserData.uid || '' ),
					message: $( "#messageContent" ).val() || "",
					replyMessageId: $( "#selectMessageId" ).val() || ""
				}


				//fileUrl5T = ""; //準備傳到後端的檔案網址
				//fileContent; //當有選取檔案,這裡就會有內容,用於上傳
				//fileName = '';
				//fileType = '';
				if ( fileUrl.length > 0 ) {
					postData.file = fileUrl;
					postData.fileName = fileName || '';
					postData.fileType = fileType || '';
				}

				xhr.send( JSON.stringify( postData ) );


				/*
				$.post(
				url.concat( "create" ), {
				channelId: "public",
				tempHash: ( authUserData.uid || '' ).toString().concat( new Date().getTime() ),
				message: $( "#messageContent" ).val() || "",
				replyMessageId: $( "#selectMessageId" ).val() || "",
				file: fileContent || "",
				fileName: $( "#fileUpload" ).val()
				},
				function ( data ) {
				//獲得回傳
				console.info( data );
				try {
				$( "#oneMessage" ).val( JSON.stringify( data, null, " " ) );
				$( "#returnError" ).val( getJson.error );
				} catch ( err3 ) {
				console.warn( err3 );
				} //try
				}
				);
				*/
				//}
			} catch ( error ) {
				console.warn( error );
			}
		}

		function upToPost() {
			try {
				console.info( 'upToPost' );

				console.info( fileContent );

				let Length = 0;

				if ( fileContent !== undefined ) {
					Length = fileContent.byteLength;
				}



				if ( Length > 0 ) { //fileContent可能undefined


					console.info( 'fileName : ' );
					console.info( fileName );

					let fileNameSub = '.tmp';


					let idot = fileName.lastIndexOf( '.' );
					if ( idot > -1 ) {
						fileNameSub = fileName.substr( idot ); //取原始副檔名
					}



					console.info( 'fileContent : ' );
					console.info( fileContent );

					let timeNow = new Date();

					let path = 'uploadTemp/'.concat( userData.uid, '/', timeNow.getTime(), fileNameSub );
					console.info( 'path='.concat( path ) );

					let storageRef = storage5t.ref( path ); //5T區域路徑

					let uploadTask = storageRef.put( fileContent );

					uploadTask.on( 'state_changed', function ( snapshot ) {
						// Observe state change events such as progress, pause, and resume
						// Get task progress, including the number of bytes uploaded and the total number of bytes to be uploaded
						let progress = 0;

						if ( snapshot.bytesTransferred > 0 ) {
							Math.roundDecimal
							progress = Math.ceil( ( snapshot.bytesTransferred / snapshot.totalBytes ) * 100 ); // RoundFloat;
						}

						console.info( 'progress = '.concat( progress, ' %' ) );

						switch ( snapshot.state ) {
							case firebase.storage.TaskState.PAUSED: // or 'paused'
								console.info( 'Upload is paused' );
								break;
							case firebase.storage.TaskState.RUNNING: // or 'running'
								console.info( 'Upload is running' );
								break;
						}
					}, function ( errorUploadTask ) {
						//非同步錯誤訊息
						console.warn( errorUploadTask );
					}, function () {
						//非同步完成行為

						uploadTask.snapshot.ref.getDownloadURL().then( function ( downloadURL ) {
							try {

								console.info( 'File URL = '.concat( downloadURL ) );
								//範例:https://firebasestorage.googleapis.com/v0/b/sport19y0715.appspot.com/o/test%2Fpoe%E5%A4%A9%E8%B3%A6%E6%8F%9B%E7%AE%97.jpg?alt=media&token=d829d412-c7d6-4635-8294-5c3fcab6e84b
								//注意https://firebasestorage.googleapis.com/v0/b/sport19y0715.appspot.com/o/test%2Fpoe%E5%A4%A9%E8%B3%A6%E6%8F%9B%E7%AE%97.jpg 至此,內容是資訊JSON不是檔案內容.
								//要加上 ?alt=media&token=... 之後才是圖片內容

								fileUrl5T = downloadURL;

								$( '#img_see2' ).attr( 'src', downloadURL );

								console.info( 'sendPost( downloadURL );' );
								sendPost( downloadURL );
							} catch ( errorGetDownloadURL ) {
								console.warn( errorGetDownloadURL );
							}

						} ); //uploadTask.snapshot.ref.getDownloadURL().then

					} ); //uploadTask.on

				} //if >0
				else {
					console.info( 'sendPost();' );
					sendPost();
				}
			} catch ( error ) {

			}
		}

		function init2() {
			console.info( "init2();" );

			const firebaseConfig = {
				apiKey: "AIzaSyB31V6WewUi-iY12231Ixahquf68uGaoCo",
				authDomain: "sport19y0715.firebaseapp.com",
				databaseURL: "https://sport19y0715.firebaseio.com",
				projectId: "sport19y0715",
				storageBucket: "sport19y0715.appspot.com",
				messagingSenderId: "179049951227",
				appId: "1:179049951227:web:15b2ae874d653216"
			};

			/*
			const firebaseConfig = {
			apiKey: "d23e597f8c957a12606f4b77bde670dbafe0182f",
			authDomain: "sport19y0715.web.app",
			projectId: "sport19y0715",
			databaseURL: "https://sport19y0715.firebaseio.com",
			storageBucket: "sport19y0715.appspot.com",
			appId: "1:179049951227:web:15b2ae874d653216",
			messagingSenderId: "179049951227"
			};*/

			try {
				firebase.initializeApp( firebaseConfig );
			} catch ( error ) {
				console.warn( error );
			}

			firebaseAuth = firebase.auth();
			//firebaseAuth.languageCode = 'zh-TW';
			firebaseAuth.useDeviceLanguage();
			firebaseAuth.onAuthStateChanged( function ( user ) {
				//不經過後端,只用前端達成的用戶驗證資料,只有uid可用

				authUserData = user;

				console.info( 'onAuthStateChanged >>> user' );
				console.info( authUserData );

				if ( ( authUserData.uid !== undefined ) || ( authUserData.uid !== null ) ) { //如果有登入的uid,就取得其他用戶資料
					getUserDataX();
				} else {
					//這裡是沒有登入的行為
				}


			} );

			rtdb = firebase.database(); //Realtime database

			storage5t = firebase.storage();

			//fsdb = firebase.firestore(); //Cloud Firestore

			//設定監聽realtime資料庫的
			rtdb.ref( "/livePush" )
				.limitToLast( 50 )
				.on( "value", function ( snapshot ) {
					//監聽之後這邊的行為是收到資料的行為.
					let svList = snapshot.val(); //你收到的內容,不穩定的json格式
					//console.info(sv);

					//array.forEach(element => {});

					for ( const key in svList ) {
						try {
							let sv = svList[ key ];
							console.info( sv );
							//前端行為邏輯在此...
							switch ( sv.action ) {
								//檢查這是什麼狀態訊息
								case "newMessage": //新訊息
									if ( sv.uid == authUserData.uid ) {
										console.info( "tempHashReolaceToMesageId" );
										tempHashReolaceToMesageId( sv );
									} else {
										console.info( "newMessageAppend" );
										newMessageAppend( sv );
									}
									break;

								case "deleteMessage": //刪除訊息(只對用戶自己刪除/隱藏)
									console.info( "delMessage" );
									delMessage( sv );
									break;
							}
						} catch ( errfor ) {
							console.warn( errfor );
						} //try
					} //for
				} );



			let xhr = new XMLHttpRequest();
			xhr.open( "POST", url.concat( "last" ), true );
			xhr.setRequestHeader( "Content-type", "application/json" );
			xhr.withCredentials = true;
			//let params = {};
			xhr.onreadystatechange = function () {
				try {
					if ( xhr.readyState == 4 && xhr.status == 200 ) {

						//
						console.info( xhr.response );
						let getJson = JSON.parse( xhr.response );

						$( "#oneMessage" ).val( JSON.stringify( getJson, null, " " ) );

						getJson.list.forEach( msg => {

							try {
								oldMessagePrepend( msg );
							} catch ( error4 ) {
								console.warn( error4 );
							}


						} );

						$( "#returnError" ).val( getJson.error );

					} //if

				} catch ( err ) {
					console.warn( err );
				} //try


			}; //onreadystatechange

			xhr.send( JSON.stringify( {
				channelId: "public"
			} ) );


			/*
			$.post(
				url.concat( "last" ), {
					channelId: "public"
					//deleteAction: 1
				},
				function ( data ) {
					//獲得回傳
					//console.info("last");
					//console.info(data);
					try {
						//$("#oneMessage").val(JSON.stringify(data, null, "  "));
						//$("#returnError").val(getJson.error);
						data.list.forEach( msg => {
							oldMessagePrepend( msg );
						} );
					} catch ( err3 ) {
						console.warn( err3 );
					} //try
				}
			);
			*/

			/*
		//取得過去的狀態訊息50筆//參考,不使用
		rtdb.ref('/message').limitToLast(50).once('value', function(snapshot) {

		let sv=snapshot.val();//你收到的內容,不穩定的json格式
		console.info( sv );

		//前端行為邏輯在此...

		});*/

			$( "#bt_clearId" ).click( function () {
				$( "#selectMessageId" ).val( "" );
			} );

			$( "#bt_clearFile" ).click( function () {
				upClear();
			} );

			$( "#fileUpload" ).change( function () {
				//監聽上傳按鈕的事件
				console.info( "fileUpload change" );

				fileContent = undefined; //先清空

				let fi_path = $( "#fileUpload" ).val();
				if ( fi_path.length < 1 ) {


					upClear();
				} else {


				}

				try {
					//有可能失敗,必須try
					//fi_path=$.('#fi_send').val();
					//有檔案路徑,不可信的臨時路徑

					File1 = $( "#fileUpload" )[ 0 ].files[ 0 ] || ""; //檔案uri,給檔案物件讀取用的

					fileToBuffer( File1 ); //=>fileContent=>fileToBase64(File1)



					/*
											let FileReaderBuffer = new FileReader(); //檔案讀取物件
											FileReaderBuffer.onload = function ( e ) {

												try {
													//console.info( "FileReaderBuffer onload>>>>" );

													fileBuffer = e.currentTarget.result; //buffer格式內容,

													if ( fileBuffer.byteLength < 1 ) {
														//沒有內容
														console.warn( 'fileBuffer 沒有內容' );
														upClear(); //失敗就清空
														return;
													} //if <1

													//有內容,byteLength是真實有效長度,byteLength不存在表示讀取失敗,

													if ( fileBuffer.byteLength > 50 * 1024 * 1024 ) { //檔案大於50MB,放棄
														console.warn( '檔案大於50MB,不允許上傳' );
														upClear(); //失敗就清空
														return;
													}

													fileContent = fileBuffer;



												} catch ( errorFileReaderBuffer ) {
													console.warn( errorFileReaderBuffer );
													//upClear(); //失敗就清空
												} //try errorFileReaderBuffer
											}; //FileReaderBuffer.onload

											FileReaderBuffer.readAsArrayBuffer( File1 ); //Buffer


											//==========================================================

											let FileReaderBase64 = new FileReader(); //檔案讀取物件//注意,base64不會自動轉回bin,所以不要用base64上傳
											FileReaderBase64.onload = function ( e ) {
												//讀取成功的行為

												try {
													console.info( "FileReader onload>>>>" );
													console.info( e );

													if ( fileContent.length > 50 * 1024 * 1024 ) {
														alert( '檔案太大,無法上傳' );
														return;
													}

													//fileContent = e.currentTarget.result || "";
													$( "#img_see" ).attr( "src", e.currentTarget.result || "" );
													$( "#fileSize" ).val( kmb( fileContent.length ) );

													//fileContent = str_def(e.currentTarget.result, "");
												} catch ( errFileReaderBase64 ) {
													console.warn( errFileReaderBase64 );
													$( "#fileUpload" ).val( "" ); //失敗就清空
													$( "#fileUpload" ).change();
												}
											};

											FileReaderBase64.readAsDataURL( File1 ); //真的讀取
											//FileReaderBase64.readAsArrayBuffer
					*/


				} catch ( e3 ) {
					console.warn( e3 );
					upClear();
				}


			} );

			$( "#bt_delete0" ).click( function () {
				try {
					console.info( "#bt_delete0 clk " );
					//console.info(this);
					//console.info($(this).attr("id"));
					let msgId = $( "#selectMessageId" ).val();
					//$("#selectMessageId").val(msgId);
					if ( msgId.length > 0 ) {

						let xhr = new XMLHttpRequest();
						xhr.open( "POST", url.concat( "delete" ), true );
						xhr.setRequestHeader( "Content-type", "application/json" );
						xhr.withCredentials = true;
						//let params = {};
						xhr.onreadystatechange = function () {
							try {
								if ( xhr.readyState == 4 && xhr.status == 200 ) {

									try {
										console.info( xhr.response );
										let getJson = JSON.parse( xhr.response );

										console.info( getJson );
										$( "#oneMessage" ).val( JSON.stringify( getJson, null, " " ) );
										$( "#returnError" ).val( getJson.error );
									} catch ( err3 ) {
										console.warn( err3 );
									} //try
								} //if
							} catch ( err ) {
								console.warn( err );
							} //try


						}; //onreadystatechange

						xhr.send( JSON.stringify( {
							messageId: msgId,
							deleteAction: 0
						} ) );



						/*
						$.post(
							url.concat( "delete" ), {
								messageId: msgId,
								deleteAction: 0
							},
							function ( data ) {
								//獲得回傳
								console.info( data );
								try {
									$( "#oneMessage" ).val( JSON.stringify( data, null, "  " ) );
									$( "#returnError" ).val( getJson.error );
								} catch ( err3 ) {
									console.warn( err3 );
								} //try
							}
						);
						*/
					}
				} catch ( err ) {
					console.warn( err );
				}
			} );

			$( "#bt_delete1" ).click( function () {
				try {
					console.info( "#bt_delete1 clk " );
					//console.info(this);
					//console.info($(this).attr("id"));
					let msgId = $( "#selectMessageId" ).val();
					//$("#selectMessageId").val(msgId);
					if ( msgId.length > 0 ) {


						let xhr = new XMLHttpRequest();
						xhr.open( "POST", url.concat( "delete" ), true );
						xhr.setRequestHeader( "Content-type", "application/json" );
						xhr.withCredentials = true;
						//let params = {};
						xhr.onreadystatechange = function () {
							try {
								if ( xhr.readyState == 4 && xhr.status == 200 ) {

									try {
										console.info( xhr.response );
										let getJson = JSON.parse( xhr.response );
										$( "#oneMessage" ).val( JSON.stringify( getJson, null, " " ) );
										$( "#returnError" ).val( getJson.error );
									} catch ( err3 ) {
										console.warn( err3 );
									} //try
								} //if
							} catch ( err ) {
								console.warn( err );
							} //try


						}; //onreadystatechange

						xhr.send( JSON.stringify( {
							messageId: msgId,
							deleteAction: 1
						} ) );


						/*
						$.post(
							url.concat( "delete" ), {
								messageId: msgId,
								deleteAction: 1
							},
							function ( data ) {
								//獲得回傳
								console.info( data );
								try {
									$( "#oneMessage" ).val( JSON.stringify( data, null, "  " ) );
									$( "#returnError" ).val( getJson.error );
								} catch ( err3 ) {
									console.warn( err3 );
								} //try
							}
						);
						*/
					}
				} catch ( err ) {
					console.warn( err );
				}
			} );

			$( "#bt_delete_1" ).click( function () {
				try {
					console.info( "#bt_delete_1 clk " );
					//console.info(this);
					//console.info($(this).attr("id"));
					let msgId = $( "#selectMessageId" ).val();
					//$("#selectMessageId").val(msgId);
					if ( msgId.length > 0 ) {


						let xhr = new XMLHttpRequest();
						xhr.open( "POST", url.concat( "delete" ), true );
						xhr.setRequestHeader( "Content-type", "application/json" );
						xhr.withCredentials = true;
						//let params = {};
						xhr.onreadystatechange = function () {
							try {
								if ( xhr.readyState == 4 && xhr.status == 200 ) {

									try {
										console.info( xhr.response );
										let getJson = JSON.parse( xhr.response );
										$( "#oneMessage" ).val( JSON.stringify( getJson, null, " " ) );
										$( "#returnError" ).val( getJson.error );
									} catch ( err3 ) {
										console.warn( err3 );
									} //try

								} //if
							} catch ( err ) {
								console.warn( err );
							} //try


						}; //onreadystatechange

						xhr.send( JSON.stringify( {
							messageId: msgId,
							deleteAction: -1
						} ) );



						/*
						$.post(
							url.concat( "delete" ), {
								messageId: msgId,
								deleteAction: -1
							},
							function ( data ) {
								//獲得回傳
								console.info( data );
								try {
									$( "#oneMessage" ).val( JSON.stringify( data, null, "  " ) );
									$( "#returnError" ).val( getJson.error );
								} catch ( err3 ) {
									console.warn( err3 );
								} //try
							}
						);
						*/
					}
				} catch ( err ) {
					console.warn( err );
				}
			} );

			$( "#bt_report" ).click( function () {
				try {
					console.info( "#bt_report clk " );
					//console.info(this);
					//console.info($(this).attr("id"));
					let msgId = $( "#selectMessageId" ).val();
					//$("#selectMessageId").val(msgId);
					if ( msgId.length > 0 ) {


						let xhr = new XMLHttpRequest();
						xhr.open( "POST", url.concat( "report" ), true );
						xhr.setRequestHeader( "Content-type", "application/json" );
						xhr.withCredentials = true;
						//let params = {};
						xhr.onreadystatechange = function () {
							try {
								if ( xhr.readyState == 4 && xhr.status == 200 ) {

									//
									console.info( xhr.response );
									let getJson = JSON.parse( xhr.response );
									$( "#oneMessage" ).val( JSON.stringify( getJson, null, " " ) );
									$( "#returnError" ).val( getJson.error );

								} //if
							} catch ( err ) {
								console.warn( err );
							} //try


						}; //onreadystatechange

						xhr.send( JSON.stringify( {
							messageId: msgId,
							reportAction: 1
						} ) );

						/*
						$.post(
							url.concat( "report" ), {
								messageId: msgId,
								reportAction: 1
							},
							function ( data ) {
								//獲得回傳
								console.info( data );
								try {
									$( "#oneMessage" ).val( JSON.stringify( data, null, "  " ) );
									$( "#returnError" ).val( getJson.error );
								} catch ( err3 ) {
									console.warn( err3 );
								} //try
							}
						);
						*/
					}
				} catch ( err ) {
					console.warn( err );
				}
			} );

			$( "#bt_report_1" ).click( function () {
				try {
					console.info( "#bt_report_1 clk " );
					//console.info(this);
					//console.info($(this).attr("id"));
					let msgId = $( "#selectMessageId" ).val();
					//$("#selectMessageId").val(msgId);
					if ( msgId.length > 0 ) {



						let xhr = new XMLHttpRequest();
						xhr.open( "POST", url.concat( "report" ), true );
						xhr.setRequestHeader( "Content-type", "application/json" );
						xhr.withCredentials = true;
						//let params = {};
						xhr.onreadystatechange = function () {
							try {
								if ( xhr.readyState == 4 && xhr.status == 200 ) {

									//
									console.info( xhr.response );
									let getJson = JSON.parse( xhr.response );

									$( "#oneMessage" ).val( JSON.stringify( getJson, null, " " ) );
									$( "#returnError" ).val( getJson.error );
								} //if
							} catch ( err ) {
								console.warn( err );
							} //try


						}; //onreadystatechange

						xhr.send( JSON.stringify( {
							messageId: msgId,
							reportAction: -1
						} ) );

						/*
						$.post(
							url.concat( "report" ), {
								messageId: msgId,
								reportAction: -1
							},
							function ( data ) {
								//獲得回傳
								console.info( data );
								try {
									$( "#oneMessage" ).val( JSON.stringify( data, null, "  " ) );
									$( "#returnError" ).val( getJson.error );
								} catch ( err3 ) {
									console.warn( err3 );
								} //try
							}
						);
						*/
					}
				} catch ( err ) {
					console.warn( err );
				}
			} );

			//bt_send
			$( "#bt_send" ).click( function () {
				try {
					console.info( "#bt_send clk " );

					//非同步
					//先上傳檔案
					upToPost();
					//再發送post




				} catch ( err ) {
					console.warn( err );
				}
			} );

			$( "#messagePool" ).on( "click", ".msg", function () {
				try {
					console.info( "#messagePool .msg clk " );
					//console.info(this);
					//console.info($(this).attr("id"));
					let msgId = $( this ).attr( "id" ) || "";
					$( "#selectMessageId" ).val( msgId );
					if ( msgId.length > 0 ) {



						let xhr = new XMLHttpRequest();
						xhr.open( "POST", url.concat( "get" ), true );
						xhr.setRequestHeader( "Content-type", "application/json" );
						xhr.withCredentials = true;
						//let params = {};
						xhr.onreadystatechange = function () {
							try {
								if ( xhr.readyState == 4 && xhr.status == 200 ) {

									//
									console.info( xhr.response );
									let getJson = JSON.parse( xhr.response );

									$( "#oneMessage" ).val( JSON.stringify( getJson, null, " " ) );
									$( "#img_see3" ).attr( 'src', url.concat( 'file', '/', getJson.fileUploadId ) );

									$( "#returnError" ).val( getJson.error );


								} //if
							} catch ( err ) {
								console.warn( err );
							} //try


						}; //onreadystatechange

						xhr.send( JSON.stringify( {
							messageId: msgId
						} ) );


						/*
						$.post(
							url.concat( "get" ), {
								messageId: msgId
							},
							function ( data ) {
								//獲得回傳
								console.info( data );
								try {
									$( "#oneMessage" ).val( JSON.stringify( data, null, "  " ) );
									$( "#returnError" ).val( getJson.error );
								} catch ( err3 ) {
									console.warn( err3 );
								} //try
							}
						);
						*/
					}
				} catch ( err ) {
					console.warn( err );
				}
			} );

			function send() {
				let messageContent = $( "#messageContent" ).val(); //;

				if ( $.trim( messageContent ).concat( fileContent ).length > 0 ) {
					// 有文字 或是 有檔案 才送出
					let re = $.trim( $( "#re_hash" ) ); //如果是回應文章就會有hash

					let xhr = new XMLHttpRequest();
					xhr.open( "POST", url.concat( "user" ), true );
					xhr.setRequestHeader( "Content-type", "application/json" );
					xhr.withCredentials = true;
					//let params = {};
					xhr.onreadystatechange = function () {
						try {
							if ( xhr.readyState == 4 && xhr.status == 200 ) {

								//
								console.info( xhr.response );
								let getJson = JSON.parse( xhr.response );


							} //if
						} catch ( err ) {
							console.warn( err );
						} //try


					}; //onreadystatechange

					xhr.send( JSON.stringify( {
						uhash: mydata.uhash, //發送者hash
						re_hash: re, //回文hash
						send_message: msg,
						send_file: fileContent
					} ) );



					/*
					$.post(
						"/creat", {
							uhash: mydata.uhash, //發送者hash
							re_hash: re, //回文hash
							send_message: msg,
							send_file: fileContent
						},
						function ( data ) {
							//獲得回傳
						}
					);*/
				} else {
					alert( "沒有 內文 也沒有 夾帶檔案 ,不處理" );
				}
			}
		}


		function getUserDataJ() {

			$.ajax( {
				url: url.concat( "user" ),
				type: "POST",
				xhrFields: {
					withCredentials: true
				},
				crossDomain: true,
				success: function ( data ) {
					//獲得回傳
					try {
						console.info( data );

						let userData1 = data.userData; // JSON.parse( xhr.response );

						//

						if ( $.trim( userData1.uid || '' ).length > 0 ) {
							userData = userData1;

							console.info( "登入身分是: ".concat( authUserData.uid ) );
						} else {
							//console.warn( "登入失敗: ".concat( getJson.error ) );
						}
					} catch ( err ) {
						console.warn( err );

						$( '#returnError' ).val( err.toString() );
					} //try
				}
			} );

		}


		function getUserDataX( m = 'GET' ) {
			let xhr = new XMLHttpRequest();
			xhr.open( "POST", url.concat( "user" ), true );
			xhr.setRequestHeader( "Content-type", "application/json" );
			xhr.withCredentials = true;
			//let params = {};
			xhr.onreadystatechange = function () {
				try {
					if ( xhr.readyState == 4 && xhr.status == 200 ) {

						//
						console.info( xhr.response );
						let getJson = JSON.parse( xhr.response );

						if ( $.trim( getJson.uid ).length > 0 ) {
							userData = getJson;

							console.info( "登入身分是: ".concat( getJson.displayName ) );
						} else {
							//console.warn( "登入失敗: ".concat( getJson.error ) );
						}
					} //if
				} catch ( err ) {
					console.warn( err );
				} //try


			}; //onreadystatechange

			xhr.send( JSON.stringify( {} ) );

		}

		function init() {
			//初始化行為
			console.info( "init();" );

			//getUserDataX(); //先檢查登入並拿到登入資料

			init2();

		}

		//File1 = $( "#fileUpload" )[ 0 ].files[ 0 ] || ""; //檔案uri,給檔案物件讀取用的
		//$( "#fileUpload" )[ 0 ] => '<input name="fileUpload" type="file" id="fileUpload">'

		//$( "#fileUpload" )[ 0 ].files => FileList 
		//{
		// 0: File
		// {
		// lastModified: 1573457761550
		// lastModifiedDate: Mon Nov 11 2019 15:36:01 GMT+0800 (台北標準時間) {}
		// name: "01.jpg"
		// size: 255574
		// type: "image/jpeg"
		// webkitRelativePath: ""
		// }
		// , length: 1
		//}

		//$( "#fileUpload" )[ 0 ].files[ 0 ] = > File
		//{
		// lastModified: 1573457761550
		// lastModifiedDate: Mon Nov 11 2019 15:36:01 GMT+0800 (台北標準時間) {}
		// name: "01.jpg"
		// size: 255574
		// type: "image/jpeg"
		// webkitRelativePath: ""
		//}
	</script>

</html>